<!DOCTYPE html>
<meta charset="utf-8">
<style>
    svg {
        font: 10px sans-serif;
        display: inline;
    }

    path{
        cursor: pointer;
    }
    
    .key path {
        display: none;
    }

    .key line {
        stroke: #000;
        shape-rendering: crispEdges;
    }

    .key text {
        font-size: 10px;
    }
</style>
<body>
    <div id="map-container"></div>
    <div id="legend"></div>
    <div id="left-column">
        <input type="text" id="town-search" />
        <button name="hideshow">CLICKME</button>
    </div>
    <script src="libs/d3.min.js"></script>
    <script src="libs/d3.topojson.min.js"></script>
    </div>    
<script>

    // Set window height + width
    var width = 500,
        height = 650;

    // Define map projection
    var projection = d3.geo.transverseMercator()
        .rotate([72.57, -44.20])
        .translate([175,185])
        .scale([12000]);
        window.proje = projection

    // Define path generator
    var path = d3.geo.path()
        .projection(projection);

    // Create SVG Element
    var svg = d3.select("#map-container").append("svg")
        .attr("width", width)
        .attr("height", height);

    // Define scale to sort data values into color buckets
    var color = d3.scale.ordinal().domain(['HYC','NUC','PET','SUN','WAS','WND','WWW'])
        .range(["#f00","#0f0","#00f","#ff0","#0ff","#abc","#000"]);

    // Legend Stuff
    d3.select("#legend").selectAll("div").data(color.domain())
        .enter().append("div")
            .style("background-color", function(d){ return color(d)})
            .style("height", "1em")
            .attr("width", 0)
            .transition()
            .attr("width", "20px")
            .text(function(d){ return d })


    d3.json("json/vermont.json", function(error, vt) {
      // if (error) return console.error(error);
      // svg.append("path")
      //     .datum(topojson.feature(vermont, vermont.objects.vt_towns))
      //     .attr("d", d3.geo.path().projection(d3.geo.mercator()));
        var vermont = topojson.feature(vt, vt.objects.vt_towns);
        svg.append("path")
            .datum(vermont)
            .attr("d", path)
            .style("stroke", "#eee")
            .style("stroke-width", "1")
            .style("fill", "#eee")
        
        svg.selectAll(".subunit")
                .data(topojson.feature(vt, vt.objects.vt_towns).features)
            .enter().append("path")
                .attr("d", path)
                .style("fill", "#eee")
                .on("mouseover", function(d) {
                    var xPosition = d3.mouse(this)[0];
                    var yPosition = d3.mouse(this)[1] - 30;

                    svg.append("text")
                        .attr("id", "tooltip")
                        .attr("x", xPosition)
                        .attr("y", yPosition)
                        .attr("text-anchor", "middle")
                        .attr("font-family", "sans-serif")
                        .attr("font-size", "11px")
                        .attr("font-weight", "bold")
                        .attr("fill", "black")
                        .text(d.properties.town);

                    d3.select(this)
                    .style("fill", "#509e2f");
                })
                .on("mouseout", function(d) {
                    d3.select("#tooltip").remove();

                    d3.select(this)
                    .style("fill", "#eee")
                })

        /* Load powerplants */
        d3.json("powerplant.json", function(error, powerplants){
            var plants = d3.select("svg").append("g")

            var bound = plants.selectAll("circle").data(powerplants.DATA, function(d){
                    return (d && d['Plant Code'])
                })
            
            bound.enter()
                .append("circle")
                .attr("cx", function(d){ 
                    return projection([d.lon,d.lat])[0]})
                .attr("cy", function(d){ return projection([d.lon, d.lat])[1]})
                .style("fill", function(d,i){ return color(d['Aggregate Fuel Type'])  })
                .attr("r", 0)
                .transition().duration(1000)
                .attr("r", 10)


            var showing = true
            var circles = d3.selectAll("circle")
            d3.select("[name=hideshow]").on("click", function(){
                if(showing){
                    circles.attr("r",10).transition().attr("r",0)
                }else{
                    circles.attr("r",0).transition().attr("r",10)
                }
                showing = !showing
            })
                
        })

        var paths = svg.selectAll("path")
        d3.select("#town-search").on("keyup", function(){
            var townName = this.value
            paths.style("fill", function(d){
                    if(d && d.properties){
                        var dTown = d.properties.town
                        if( dTown.toLowerCase().indexOf(townName.toLowerCase()) == -1 || townName.trim().length == 0){
                            return '#eee'
                        }else{
                            return '#f00'
                        }
                    }
                })
        })

    


        // var g = svg.append("g")
        //     .attr("class", "key")
        //     .attr("transform", "translate(320, 165)")
        //     .call(yAxis);
    });


</script>
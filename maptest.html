<!DOCTYPE html>
<head xmlns="http://www.w3.org/1999/html">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="stylesheet" type="text/css" href="css/foundation.min.css">
    <link rel="stylesheet" type="text/css" href="css/map.css">

    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <!--<script src="js/jquery-2.1.1.js"></script>-->
    <!--<script src="js/d3.min.js"></script>-->
    <!--<script src="js/foundation.min.js"></script>-->
    <!--<script src="js/modern.js"></script>-->
    <script src="js/modernizr.js"></script>
    <script src="js/jquery-2.1.1.js"></script>
    <script src="js/foundation.min.js"></script>

    <script type="text/javascript" src="https://www.google.com/jsapi"></script>
    <script>


    </script>

    <script src="js/chartLoader.js"></script>
    <script src="js/josh.js"></script>

    <link rel="stylesheet" type="text/css" href="css/normalize.css">
    <link rel="stylesheet" type="text/css" href="css/foundation.min.css">
    <link rel="stylesheet" type="text/css" href="css/foundation-icons.css">


    <link rel="stylesheet" type="text/css" href="css/foundation.min.css">
    <link rel="stylesheet" type="text/css" href="css/map.css">
    <link rel="stylesheet" type="text/css" href="css/josh.css">


</head>
<body>
    <div class="row container panel">
        <div id="sidebar-view-1" class="small-12 large-4 large-push-8 columns">
            <dl class="tabs" data-tab>
                <dd class="tab active" id="generation-tab"><a href="#generation-panel">Generation</a></dd>
                <dd class="tab" id="consumption-tab"><a href="#consumption-panel">Consumption</a></dd>
            </dl>
            <div class="tabs-content">
                <div id="generation-panel" class="content active">
                    <div id="legend"></div>
                    <div id="data">
                        <span name="status"></span>
                        <img name="loading" src="images/loader.gif" style="display: none">
                        <select name="chartselect" style="display:none;">
                            <option>Select a Power Plant</option>
                        </select>
                        <svg id="powerplantchart"></svg>

                        <div class="lineContainer chartContainer">

                            <div id="powerplantChart"></div>
                        </div>

                        <div class="pieContainer chartContainer">
                            <div id="pieTitle">Total Generation by Type</div>
                            <div id="pieChart"></div>
                        </div>




                    </div>
                </div>
                <div id="consumption-panel" class="content">
                    <input type="text" id="town-search" placeholder="Search Town">
                    <div>
                        <h5><strong>All Households:</strong></h5>
                        <p>
                            <strong>Average KWH Consumed Per Month</strong>
                            <br />
                            634.59
                        </p>
                        <p>
                            <strong>Average KWH Generated Per Month</strong>
                            <br />
                            4.47
                        </p>
                        <p>
                            <strong>Net KWH Used</strong>
                            <br />
                            630.12
                        </p>

                        <h5><strong>Households that generate power:</strong></h5>
                        <p>
                            <strong>Average KWH Consumed Per Month</strong>
                            <br />
                            685.51
                        </p>
                        <p>
                            <strong>Average KWH Consumed Per Month</strong>
                            <br />
                            760.41
                        </p>
                        <p>
                            <strong>Net KWH Used</strong>
                            <br />
                            -74.9
                        </p>
                    </div>
                </div>
            </div>
        </div>
        <div id="sidebar-view-2" class="small-12 large-4 large-push-8 columns" style="display:none">
            <h2 class="town-name">Montpelier</h2>
        </div>
        <div id="map-container" class="small-12 large-8 large-pull-4 columns">
            <div class="map"></div>

        </div>
    </div>


    <button id="showJosh">show josh</button>
    <button id="hideJosh">hide josh</button>
    <a href="#" id="reveal_button" data-reveal-id="myModal" class="button" style="display: none">Launch Signup Modal</a>

    <div id="myModal" class="reveal-modal remove-whitespace " data-reveal="myModal" >
        <div class="row">
            <div class="user_profile">
                <div>
                    <div class="profile_nest">
                        <img class="profile_img" style="display: inline-block" src="images/profiles/usher.png"/>
                        <div class="profile_title">Max Headroom</div>
                    </div>
                </div>

                <div class="user_data">
                    <div class="household_size">
                        <div class="household_images">
                            <img class="persona" src="images/persona.png"/>
                            <img class="persona" src="images/persona.png"/>
                            <img class="persona persona_child" src="images/persona_child.png"/>
                        </div>
                    </div>
                    <div class="energy_data data_block">
                        <ul style="margin-top: 4px;" class="house_details_list details_list">
                            <li><span class="li-title">Adults</span>2 - Full-Time</li>
                            <li><span class="li-title">Children</span>1 - College</li>
                            <li><span class="li-title">Pets</span>0</li>
                        </ul>
                    </div>
                    <div class="house_data data_block">
                        <div class="household_size">
                            <img src="images/1987_house.png" class='house_icon'/>
                        </div>
                        <ul class="details_list">
                            <li><span class="li-title">SQFT</span>2000</li>
                            <li><span class="li-title">Renew</span>Solar</li>
                            <li><span class="li-title">Heat</span>Wood (3-5 cord)</li>
                            <li><span class="li-title"></span>Oil (300-400Gal)</li>
                            <li><span class="li-title">Auto</span>Electric Car</li>
                        </ul>
                    </div>
                </div>
                <div class="trendline_nest">
                    <img src="images/trendline_user1.png"/>
                </div>
            </div>

            <div class="user_profile_spacer"></div>
            <div class="user_profile">
                <div>
                    <div class="profile_nest">
                        <img class="profile_img" style="display: inline-block" src="images/profiles/angelina.png"/>
                        <div class="profile_title">Emelia Pitt</div>
                    </div>
                </div>

                <div class="user_data">
                    <div class="household_size">
                        <div class="household_images">
                            <img class="persona" src="images/persona.png"/>
                            <img class="persona" src="images/persona.png"/>
                            <img class="persona persona_child" src="images/persona_child.png"/>
                        </div>
                    </div>
                    <div class="energy_data data_block">
                        <ul style="margin-top: 4px;" class="house_details_list details_list">
                            <li><span class="li-title">Adults</span>1 - Full Time</li>
                            <li><span class="li-title"></span>1 - S.A.H</li>
                            <li><span class="li-title">Children</span>2 - Public School</li>
                            <li><span class="li-title">Children</span>1 - Pre-School</li>
                            <li><span class="li-title">Pets</span>0</li>
                        </ul>
                    </div>
                    <div class="house_data data_block">
                        <div class="household_size">
                            <img src="images/1968_house.png" class='house_icon'/>
                        </div>
                        <ul class="details_list">
                            <li><span class="li-title">SQFT</span>1800</li>
                            <li><span class="li-title">Renew</span>NONE</li>
                            <li><span class="li-title">Heat</span>Gas</li>
                            <li><span class="li-title"></span>Electric Hot Water</li>
                            <li><span class="li-title">Auto</span>Unknown</li>
                        </ul>
                    </div>
                </div>

                <div class="trendline_nest">
                    <img src="images/trendline_user2.png"/>
                </div>
            </div>
        </div>
        <div class="row row-spacer"></div>

        <div class="row">
            <div class="user_profile">
                <div>
                    <div class="profile_nest">
                        <img class="profile_img" style="display: inline-block" src="images/profiles/willie.png"/>
                        <div class="profile_title">Willie Relaxo</div>
                    </div>
                </div>

                <div class="user_data">
                    <div class="household_size">
                        <div class="household_images">
                            <img class="persona" src="images/persona.png"/>
                        </div>
                    </div>
                     <div class="energy_data data_block">
                        <ul style="margin-top: 4px;" class="house_details_list details_list">
                            <li><span class="li-title">Adults</span>1 - Full-Time</li>
                            <li><span class="li-title">Pets</span>0</li>
                        </ul>
                    </div>
                    <div class="house_data data_block">
                        <div class="household_size">
                            <img src="images/1984_house.png" class='house_icon'/>
                        </div>
                        <ul class="details_list">
                            <li><span class="li-title">SQFT</span>2000</li>
                            <li><span class="li-title">Renew</span></li>
                            <li><span class="li-title">Heat</span>Wood (3-5 cord)</li>
                            <li><span class="li-title"></span>Oil (baseboard)</li>
                            <li><span class="li-title">Auto</span>Electric Car</li>
                        </ul>
                    </div>
                </div>

                <div class="trendline_nest">
                    <img src="images/trendline_user3.png"/>
                </div>
            </div>

            <div class="user_profile_spacer"></div>
            <div class="user_profile">
                <div>
                    <div class="profile_nest">
                        <img class="profile_img" style="display: inline-block" src="images/profiles/jimmy.png"/>
                        <div class="profile_title">Jimmy Keylargo</div>
                    </div>
                </div>

                <div class="user_data">
                    <div class="household_size">
                        <div class="household_images">
                            <img class="persona" src="images/persona.png"/>
                            <img class="persona" src="images/persona.png"/>
                            <img class="persona persona_child" src="images/persona_child.png"/>
                            <img class="persona persona_child" src="images/persona_child.png"/>
                            <img class="persona persona_child" src="images/persona_child.png"/>
                        </div>
                    </div>
                    <div class="energy_data data_block">
                        <ul style="margin-top: 4px;" class="house_details_list details_list">
                            <li><span class="li-title">Adults</span>2 - Full-Time</li>
                            <li><span class="li-title">Children</span>2 - Public School</li>
                            <li><span class="li-title"></span>1 - Daycare</li>
                            <li><span class="li-title">Pets</span>0</li>
                        </ul>
                    </div>
                    <div class="house_data data_block">
                        <div class="household_size">
                            <img src="images/1967_house.png" class='house_icon'/>
                        </div>

                        <ul class="details_list">
                            <li><span class="li-title">SQFT</span>2000</li>
                            <li><span class="li-title">Renew</span>2.1kw Solar</li>
                            <li><span class="li-title"></span>4X8 Solar Hot Water</li>
                            <li><span class="li-title">Heat</span>Natural Gas (hydronic baseboard)</li>
                            <li><span class="li-title">Auto</span>Unknown</li>
                        </ul>


                    </div>
                </div>

                <div class="trendline_nest">
                    <img src="images/trendline_user4.png"/>
                </div>
            </div>
        </div>

    </div>


    
    <script src="libs/d3.min.js"></script>
    <script src="libs/d3.topojson.min.js"></script>
    <script src="js/view2.js"></script>
<script>
    $(document).foundation();
    // Set window height + width
    var width = 700,
        height = 700,
        circleRadius = 7,
        animationDuration = 1200;

    var reportsURL = "http://api.eia.gov/series/?api_key=6A24BA07916FAA6383DAABC4BAFE7BD7&series_id=<SERIES_ID_HERE>"
    var statusText = d3.select("span[name=status]")
    var loadingBar = d3.select("img[name=loading]")
    var chartBase = d3.select("#powerplantchart")
    var chartselect = d3.select("select[name=chartselect]").style('background-color','#eee')

    // Define map projection
    var projection = d3.geo.transverseMercator()
        .rotate([72.57, -44.20])
        .translate([250,230])
        .scale([15000]);

    var zoomVar = {
        "xAdj": 18.5,
        "yAdj": 18.25,
        "scale": 20

    }

    // Define path generator
    var path = d3.geo.path()
        .projection(projection);

    // Create SVG Element
    var svg = d3.select("#map-container .map").append("svg")
        .attr("id", "svgmap")
        .attr("width", width)
        .attr("height", height);

    var fuelCodes = ['HYC','NUC','PET','SUN','WAS','WND','WWW']

    var fuelColorLabels = d3.scale.ordinal().domain(fuelCodes)
        .range([
            '(Water at a Conventional Hydroelectric Turbine)',
            '(Nuclear Fission (Uranium, Plutonium, Thorium))',
            '(Petroleum)',
            '(Solar PV and thermal)',
            '(unknown)',
            '(Wind)',
            '(Wood and Wood Waste)'
            ])

    // Define scale to sort data values into color buckets
    var color = d3.scale.ordinal().domain(fuelCodes)
        .range(["#B71427","#118C4E","#6DBDD6","#FFE658","#FF9009","#DF3D82","#003366"]);

    /*  For parsing out the series data from power plant reports */ 
    var margin = {top: 20, right: 20, bottom: 30, left: 50}
    var reportChartWidth = 500 - margin.left - margin.right
    var reportChartHeigh = 300 - margin.top - margin.bottom
    var parseDate = d3.time.format("%Y").parse
    var reportX = d3.time.scale()
        .range([0, reportChartWidth])
    var reportY = d3.scale.linear()
        .range([reportChartHeigh, 0])
    var reportXAxis = d3.svg.axis()
        .scale(reportX)
        .orient("bottom");
    var reportYAxis = d3.svg.axis()
        .scale(reportY)
        .orient("left");
    var line = d3.svg.line()
        .x(function(d) { return reportX( parseDate(d[0].substring(0,3))); })
        .y(function(d) { 
            console.log(d[1], reportY(d[1]));
            return reportY(d[1]); })
        .interpolate('linear');

    chartBase
        .attr("width", reportChartWidth + margin.left + margin.right)
        .attr("height", reportChartHeigh + margin.top + margin.bottom)
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    var showData = function(id){
        var boundSelect = chartselect.selectAll("option").data(window.loadedReportData[id], function(d){
            return (d && d[0] && d[0].name) || d3.select(this).name
        })

        chartselect[0][0].onchange = function(){
            var val = this.options[this.selectedIndex]
            var datum = d3.select(val).data()[0][0]

            chartBase.selectAll(".oldreportcharts").remove() //remove any old
            
            reportX.domain(d3.extent(datum.data, function(d) { return parseDate(d[0].substring(0,3)); }));
            reportY.domain(d3.extent(datum.data, function(d) { return d[1]; }));

            chartBase.append("g")
                .attr("class", "x axis oldreportcharts")
                .attr("transform", "translate(0," + reportChartHeigh + ")")
                .call(reportXAxis);

            chartBase.append("g")
                .attr("class", "y axis oldreportcharts")
                .call(reportYAxis)
                    .append("text")
                    .attr("transform", "rotate(-90)")
                    .attr("y", 6)
                    .attr("dy", ".71em")
                    .style("text-anchor", "end")
                    .text(datum.units);

            chartBase.append("path")
                .datum(datum.data)
                .attr("class", "line oldreportcharts")
                .attr("d", line)
                .style('fill','none')
                .style('stroke','black')
                .style('stroke-width','1.2em')
            
        }
        
        
        boundSelect.enter().append("option")
            .attr('value', function(d){ return d[0].name })
            .text(function(d){ return d[0].name })

        boundSelect.exit().remove()


        chartselect[0][0].selectedIndex = 0
    }


    //Hurray Global State
    var showingConsumption = false;

    // Legend Stuff
    var legends = d3.select("#legend").append("svg")
        .style("padding","15px")
        .selectAll("g").data(color.domain());
    
    legends.enter().append("g")
        .classed(".legend-powerstation-percent", true)
        .attr("width", 0)
        .transition().duration(animationDuration)
        .attr("width", "20px")

    var legend_nodes = d3.selectAll("#legend g")
                                
    legend_nodes.append("circle")
                .style("fill", function(d){ return color(d)})
                .style('stroke', function(d){ return color(d)})
                .attr('r', "8")
                .attr("cx", "5")
                .attr("cy", function(d,i){return i *20 + 2})

    legend_nodes.append("rect")
                .style("fill", function(d){return color(d)})
                .style("stroke", function(d){return color(d)})
                .attr("x", "5")
                .attr("y", function(d,i){ return i* 20 + 2})
                .attr("width", "100px")
                .attr("height", ".5em")
    
    legend_nodes.append("text")
                .attr("x","20")
                .attr("y",function(d,i){return i*20 + 5})
                .attr("width", "100px")
                .text(function(d){ return d + " " + fuelColorLabels(d) })

    d3.json("json/vermont.json", function(error, vt) {
        var vermont = topojson.feature(vt, vt.objects.vt_towns);
        window.vermont = vermont
        svg.append("path")
            .datum(vermont)
            .attr("d", path)
            .style("stroke", "#eee")
            .style("stroke-width", "1")
            .style("fill", "#eee")
        
        svg.selectAll(".subunit")
                .data(topojson.feature(vt, vt.objects.vt_towns).features, function(d){
                    return d.properties.town 
                })
            .enter().append("path")
                .attr("d", path)
                .classed("town", true)
                .on("mouseover", function(d) {
                    if(showingConsumption){
                        var xPosition = d3.mouse(this)[0];
                        var yPosition = d3.mouse(this)[1] - 30;

                        svg.append("text")
                            .attr("id", "tooltip")
                            .attr("x", xPosition)
                            .attr("y", yPosition)
                            .attr("text-anchor", "middle")
                            .attr("font-family", "sans-serif")
                            .attr("font-size", "11px")
                            .attr("font-weight", "bold")
                            .attr("fill", "black")
                            .text(d.properties.town);

                        d3.select(this)
                            .classed("town-hover", true);
                    }
                })
                .on("mouseout", function(d) {
                    if(showingConsumption){
                        d3.select("#tooltip").remove();

                        d3.select(this)
                            .classed("town-hover", false);
                    }
                })
                .on("click", function(d){

                    if(showingConsumption){
                        console.log('zooooooooooom')
                        var coords = d3.mouse(this)
                        var town = d.properties.town
                        d3.select(this)
                                .classed("town-zoom", true);
                        magicZoomeyNess(town, coords)
                        drawDots();
                    }
                })

                function magicZoomeyNess(town, coords){
                    svg.selectAll("path")
                        .transition()
                        .attr("transform", function(d){
                            if(d && d.properties){
                                if(town == d.properties.town){
                                    return "translate(" + (-coords[0]*zoomVar.xAdj) +","+ (-coords[1]*zoomVar.yAdj)+") scale("+zoomVar.scale+")"
                                }
                            }
                            return "scale(.3)"
                        })
                    $('body').trigger('view-2');
                }

        //To hold map for Power_STationReports
        window.reportData = {}
        //To hold data loaded from querying against the ids from Power_Station_reports
        window.loadedReportData = {}

        d3.json("Power_Station_Reports.json", function(error, reportData){
            for (var i = reportData.length - 1; i >= 0; i--) {
                window.reportData[reportData[i].id] = reportData[i]
            };
        })

        /* Load powerplants */


        d3.json("powerplant.json", function(error, powerplants){
            var plants = d3.select("#svgmap").append("g")

            var bound = plants.selectAll("circle").data(powerplants.DATA, function(d){
                    return (d && d['Plant Code'])
                })

            var fillPowerPlant = function(d){ return color(d['Aggregate Fuel Type'])  }
            
            bound.enter()
                .append("circle")
                .on('click', function(d){
                    if( d.id in window.reportData){
                        statusText
                            .text("Loading Power Plant data...")
                            .style("color", "green")
                        loadingBar
                            .style("display", "block")
                            .style("opacity", "0")
                            .transition().duration(animationDuration)
                            .style("opacity", "1")


                        var repData = reportData[d.id]
                        if(d.id in window.loadedReportData){
                            loadingBar.style("display","none")
                            statusText.text("")
                            showData(d.id)
                        }else{
                            if(repData && repData.reports){
                                window.loadedReportData[d.id] = []
                                for (var i = repData.reports.length - 1; i >= 0; i--) {
                                    var seriesId = repData.reports[i]
                                    d3.json(reportsURL.replace("<SERIES_ID_HERE>", seriesId), function(error, seriesReports){
                                        window.loadedReportData[d.id].push(seriesReports.series)
                                        console.info(repData.reports.length, window.loadedReportData[d.id].length)
                                        if(repData.reports.length == window.loadedReportData[d.id].length){
                                            statusText
                                                .text("Done Loading!")
                                                .transition().duration(animationDuration).style("opacity","0")
                                                .text("")
                                            loadingBar.transition().duration(animationDuration)
                                                .style("opacity","0")
                                                .style("display", "block")
                                            showData(d.id)
                                        }
                                    })
                                };
                            }else{
                                loadingBar.style("display","none")
                                statusText
                                    .text("Power Plant has no reporting data")
                                    .style("color", "red")
                            }
                        }
                    }else{
                        loadingBar.style("display","none")
                        statusText
                            .text("Power Plant has no reporting data")
                            .style("color", "red")
                    }
                })
                .on("mouseover", function(d){
                    var plantColor = color(d['Aggregate Fuel Type']).replace("#","")
                    var tmp = plantColor
                    plantColor = plantColor + plantColor
                    plantColor = plantColor.replace(tmp, '000')
                    d3.select(this)
                        .style('fill', plantColor)
                        .transition().duration(animationDuration/2)
                        .attr("r", circleRadius*3)

                    var xPosition = d3.mouse(this)[0];
                    var yPosition = d3.mouse(this)[1] + 30;

                    svg.append("text")
                        .attr("id", "tooltip")
                        .attr("x", xPosition)
                        .attr("y", yPosition)
                        .attr("text-anchor", "middle")
                        .attr("font-family", "sans-serif")
                        .attr("font-size", "11px")
                        .attr("font-weight", "bold")
                        .attr("fill", "black")
                        .text(d['Plant Name']);

                })
                .on("mouseout", function(d){
                    d3.select("#tooltip").remove()
                    d3.select(this)
                        .style('fill', fillPowerPlant(d))
                        .transition().duration(animationDuration/2)
                        .attr("r", circleRadius)
                })
                .attr("cx", function(d){ return projection([d.lon,d.lat])[0]})
                .attr("cy", function(d){ return projection([d.lon, d.lat])[1]})
                .style("fill", fillPowerPlant)
                .attr("r", 0)
                .transition().duration(animationDuration)
                .attr("r", circleRadius)

            var circles = d3.selectAll("circle")
            d3.select("#generation-tab").on("click", function(){
                if(!showingConsumption){return}
                showingConsumption = false;
                circles.attr("r",0).transition().attr("r",circleRadius)
            })
            d3.select("#consumption-tab").on("click", function(){
                if(showingConsumption){return}
                showingConsumption = true;
                circles.attr("r",circleRadius).transition().attr("r",0)
            })


                
        })


        var paths = svg.selectAll("path")
        d3.select("#town-search").on("keyup", function(){
            var townName = this.value
            paths.classed("town-search", function(d){
                    if(d && d.properties){
                        var dTown = d.properties.town
                        return (dTown.substring(0, townName.length).toLowerCase() == townName.toLowerCase() && townName.trim().length != 0)
                    }
                })
        })

    });

    $(document).ready(function(){
        $('body').on('view-2', function(){
            d3.selectAll(".town-search")
                .classed("town-search", false);
            $("#town-search").val("");
            $("#sidebar-view-1").hide();
            $("#sidebar-view-2").show();
            showingConsumption = false;
        });
    });


</script>
